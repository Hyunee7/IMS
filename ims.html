<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IMS</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <style>
    HTML {font-family:Consolas,monospace;}
    body {background-color:#333333;color:#888888}
    #imsTitle {width:350px}
    TD {
        border-right:1px #666666 solid;
        border-bottom:1px #666666 solid;
        font-family:monospace;
        margin:0;
        padding:0;
        /*line-height:7px;*/
    }
    table {
        border-top:1px #666666 solid;
        border-left:1px #666666 solid;
    }
    .th{color:#aaaaaa}
    .channel {
        padding-right: 2px;
        color:green;
    }
    .level {
        width:1px;
        color:red;
        background-color:#c3ff00;
        height:10px;
        margin:0 0 0 0;
    }
    .insName, .insPitc, .insVolu, .insPann {
        color:#888888;
    }
    .insPitc {text-align:center;}
    .insVolu, .insEven {
        text-align:right;
    }
    .insNote {
        color:#00ccff;
        text-align:center;
    }
    .insPann {
        text-align:center;
    }
    .insEven {
        font-family:Monaco,gulimche
        color:#006600;
    }
    @supports (-webkit-touch-callout: none) {
      /* CSS specific to iOS devices */ 
        .insEven {
            display:none;
        }
    }
    #imsTitle {color:#a0a0a0;font-size: x-large;}
    #imsTempo, #imsFile {color:#a0a0a0;}
    #cur_byteDiv, #curByte {color:#996633}
    button {background-color: #00a6ed;border-radius: 10px;}

.bar {
    /*background-color: green;*/
    /**/background-color: #0a58ca;/**/
    /** /width:15px;/**/
    /**/width:7%;/**/
    height:1px;
    display: inline-block;
    vertical-align: bottom;
    position: relative;
    bottom: 0;
    left: 0;
    /*margin-right:10px;*/
    background-image: linear-gradient(0deg, #0a58ca 1px 6px, #333 7px 8px, #0a58ca 9px 14px, #333 15px 16px, #0a58ca 17px 22px, #333 23px 24px, #0a58ca 25px 30px, #333 31px 32px, #0a58ca 33px 38px, #333 39px 40px, #0a58ca 41px 46px, #333 47px 48px, #0a58ca 49px 54px, #333 55px 56px, #0a58ca 57px 62px, #333 63px 64px, #0a58ca 65px 70px, #333 71px 72px, #0a58ca 73px 78px, #333 79px 80px, #0a58ca 81px 86px, #333 87px 88px, #d33a3a 89px 94px, #333 95px 96px, #d33a3a 97px 102px, #333 103px 104px, #d33a3a 105px 110px, #333 111px 112px, #d33a3a 113px 118px, #333 119px 120px, #d33a3a 121px 125px);
    /** /
        background-image: linear-gradient(0deg, #0a58ca 0% 5%, #333 5% 6%, #0a58ca 6% 11%, #333 11% 12%, #0a58ca 12% 17%, #333 17% 18%, #0a58ca 18% 23%, #333 23% 24%, #0a58ca 24% 29%, #333 29% 30%, #0a58ca 30% 35%, #333 35% 36%, #0a58ca 36% 41%, #333 41% 42%, #0a58ca 42% 47%, #333 47% 48%, #0a58ca 48% 53%, #333 53% 54%, #0a58ca 54% 59%, #333 59% 60%, #0a58ca 60% 65%, #333 65% 66%, #0a58ca 66% 71%, #333 71% 72%, #d33a3a 72% 77%, #333 77% 78%, #d33a3a 78% 83%, #333 83% 84%, #d33a3a 84% 89%, #333 89% 90%, #d33a3a 90% 95%, #333 95% 96%, #d33a3a 96% 100%)
    /***/
}
@keyframes slidein {
  to {
    height:1px;
  }
}

.eq{
    position: relative;
    height: 130px;
    border:1px #666666 solid;
    display: flex;
    /**/justify-content:space-between;/**/
    flex-direction: row;
    align-items: flex-end;
}
canvas {
    border:1px #666666 solid;
    background-color:#181818;
    width:100%;
    height:130px;
}

    #imsIns{
        display: flex;
        flex-wrap: wrap;
    }
  </style>
  <script src="kssmcode.js?v1.00"></script>
  <script>
    var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
    var url = params && params.get("url") && decodeURIComponent(params.get("url"));
    var d = params && params.get("d") && decodeURIComponent(params.get("d"));

    Number.prototype.to2 = function(){return this<10?'0'+this:this;}
    Number.prototype.timeFormat = function(){ return Math.floor(this/60)+':'+(this%60).to2(); }
    Number.prototype.format = function(){return new String(this).replace(/\B(?<!\.\d*)(?=(\d{3})+(?!\d))/g, ",")}

var ajaxcounter = 0;
var file = '';
var tick=0;
var isRun = false;
var DEBUG = false;

    var uInt8Array;
    var imsHeader;
    var pos;
    function loadIMS(rs){
        //var uInt8Array = new Uint8Array(rs);
        uInt8Array = new Uint8Array(rs);
        ///////////////////////////////////////////////////////////////////////
        var getByte = (()=>{
            var position = 0;
            return (length, type)=>{
                var start = position;
                position += length;
                pos = position;
                type=type||'';
                if(type=='int8'){
                    return uInt8Array[start];
                } else if(type=='int16'){
                    return uInt8Array[start+1]<< 8|uInt8Array[start  ];
                } else if(type=='int32'){
                    return uInt8Array[start+3]<<24|uInt8Array[start+2]<<16
                          |uInt8Array[start+1]<< 8|uInt8Array[start  ];
                } else if(type=='pos'){
                    position = length;
                    return position;
                } else {
                    returnVal='';
                    isErr = false;
                    for(var i=0; i<length; i++){
                        var h = uInt8Array[ start+i   ];
                        //console.log(h)
                        if(h == 0x00) break; // 쓰레기값이 출력되서 EOF?처리함
                        var l = '';
                        if(uInt8Array.length > start+i+1) l = uInt8Array[ start+i+1 ];

                        if(h & 0x80) {
                            if (l == 0x00) {// continue;	/* 하위 바이트 ERROR */
                                returnVal += '[]';
                                continue;
                            }

                            var ch = ((h << 8) & 0xff00) + (l & 0xff);
                            if (ch >= 0x8861 && ch <= 0xd3b7) {	/* '가'부터 '힝'까지 2,350자 */
                                returnVal+=KSSMCODE[ch] || '';
                            } else if (ch >= 0xd931 && ch <= 0xdef1) {	/* 조합형 symbol */
                                if(!KSSMCODE[ch]){
                                    isErr = true;
                                    console.log(new Date().toJSON(),'MM', h, l, ch, ch.toString(16));
                                }
                                //returnVal+='MM';
                                returnVal+=KSSMCODE[ch] || 'MM';
                            } else {	/* 초성 'ㄱ', 종성 자음, 모음 */
                                if(!KSSMCODE[ch]){
                                    isErr = true;
                                    console.log(new Date().toJSON(),'HH', h, l, ch, ch.toString(16));
                                }
                                //returnVal+='HH';
                                returnVal+=KSSMCODE[ch] || 'HH';
                            }
                            i++;
                        } else {
                            returnVal += String.fromCharCode(uInt8Array[start+i]).replace(/\x00/g,'');
                            //returnVal += String.fromCharCode(uInt8Array[start+i]);
                        }
                    }
                    //if(length==64) 
                    //if(length>2) 
                    if(isErr)
                    console.log(new Date().toJSON(),'returnVal',returnVal);
                    return returnVal;
                }
            }
        })();

        // IMS 해더 정의
        function ImsHeader(){
            return {
                 majorVersion : getByte( 1, 'int8' ) //  1    주 버전 번호(일반적으로 1)
                ,minorVersion : getByte( 1, 'int8' ) //  2    부 버전 번호(일반적으로 0)
                ,tuneld       : getByte( 4, 'int32') //  6    노래 식별 번호
                ,tuneName     : getByte(30         ) // 36    노래 제목, null 종료
                ,tickBeat     : getByte( 1, 'int8' ) // 37    비트당 틱 수
                ,beatMeasure  : getByte( 1, 'int8' ) // 38    소절당 비트수
                ,totalTick    : getByte( 4, 'int32') // 42    노래의 길이(틱)
                ,dataSize     : getByte( 4, 'int32') // 46    MIDI 데이터 블록의 길이(바이트)
                ,nrCommand    : getByte( 4, 'int32') // 50    MIDI 이벤트 수 (0xFC:종료 포함)
                ,srctickBeat  : getByte( 1, 'int8' ) // 51    0 (이외 값은 발견하지 못함.)
                ,filler       : getByte( 7         ) // 58    패딩, 0으로 설정

                ,soundMode    : getByte( 1, 'int8' ) // 59   OPL 리듬 모드: 0=멜로딕(꺼짐), 1=타악기(켜짐)
                ,pitchBRange  : getByte( 1, 'int8' ) // 60    피치벤드 범위(1-12)

                ,basicTempo   : getByte( 2, 'int16') // 62    노래 템포, 분당 비트 수.
                ,filler2      : getByte( 8         ) // 70    패딩, 0으로 설정
            }
        }

        imsHeader = new ImsHeader();
        if(DEBUG) console.log(new Date().toJSON(),'imsHeader',imsHeader);
        document.querySelector('#imsTitle').innerText = imsHeader.tuneName;
        document.querySelector('#imsTempo').innerText = 'TEMPO : ' + imsHeader.basicTempo;
        ttem=imsHeader.basicTempo;

        tmp1 = getByte(1, 'int8')  // ?? - 0 : 0000 0000
        //console.log(new Date().toJSON(),'tmp1',tmp1);

        ch_num = 9 + imsHeader.soundMode * 2;
        if(DEBUG) console.log(new Date().toJSON(),'ch_num',ch_num);

//        console.log(new Date().toJSON(),'Data pos',pos);
        getByte(imsHeader.dataSize+72, 'pos'); // 72 : header size(70) + 악기시작 서명(2)
//        console.log(new Date().toJSON(),'pos',pos);

        //사용악기 시작 서명 0x77 0x77 ("ww")
        //tmp2_1 = getByte(1, 'int8')  // ?? - 119 : 0111 0111
        //tmp2_2 = getByte(1, 'int8')  // ?? - 119 : 0111 0111
        //console.log(new Date().toJSON(),'tmp2',tmp2);

        ins_num = getByte(2, 'int16');
        if(DEBUG) console.log(new Date().toJSON(),'ins_num',ins_num);

        //ins_name = getByte(ins_num*9);
        ins_name = [];
        for(i=0; i<ins_num; i++) ins_name.push( getByte(9) );
        if(DEBUG) console.log(new Date().toJSON(),'ins_name',ins_name);

        document.querySelector('#imsFile' ).innerText = 'File : ' + file.split('/').pop()
                                                      + ' (ins : ' + ins_num + ')'
                                                      + ' / Size : ' + uInt8Array.length.format()
                                                      + ' Bytes';

        //cur_byte = 71;
        doStart();
//        getDuration(); //재생시간 구함
        var dur = getDuration()
        tickTime.innerHTML = Math.round(dur*100)/100 + ' ' + Math.round(dur).timeFormat();

//        TimeOut();
        /*
        //getByte(71, 'pos');
        //idcode = getByte(1, 'int8');
        //cur_byte = 71;
        idcode = uInt8Array[cur_byte];
        //console.log(new Date().toJSON(),'idcode',idcode.toString(2));
        //console.log(new Date().toJSON(),'idcode',idcode.toString(16),'<0x80',idcode <0x80);

        if ( idcode <0x80 ) idcode=idcode_st;
        else { cur_byte++;idcode_st=idcode; }

        ch=0x0f & idcode;
        console.log(new Date().toJSON(),'ch',ch.toString(16));

        switch ( 0xf0 & idcode ){
            case 0xc0:ins_rt(ch);break;
            case 0xa0:vol_rt(ch);break;
            case 0xe0:pit_rt(ch);break;
            case 0xf0:tem_rt();break;
            case 0x80:note1_rt(ch);break;
            case 0x90:note2_rt(ch);break;
        }
        */


        ///////////////////////////////////////////////////////////////////////

    }

// Note 진행 Byte 수 출력
function prtCurByte(ch){
    //curByte.innerText = cur_byte.format() + ' / ' + imsHeader.dataSize.format() + ' ( ' + (Math.round(cur_byte/imsHeader.dataSize*1000)/10) + '% )';
    var b = cur_byte-71;
    var s = imsHeader.dataSize;
    ch=ch||'';
    //curByte.innerText = b.format() + ' / ' + s.format() + ' ( ' + (Math.round(b/s*1000)/10) + '% )';
    curByte.innerText = b.format() + ' / ' + s.format() + ' ( ' + (b/s*100).toFixed(2) + '% ) ' + ch;
    //console.log('prtCurByte( '+ ch +' )');
}


// 재생시간 얻기
function getDuration(){
    var tickByTime=0;
    var data2=0;
    var t_delay;
    while(true){
        idcode = uInt8Array[cur_byte];

        if ( idcode <0x80 ) idcode=idcode_st;
        else { cur_byte++;idcode_st=idcode; }

        ch=0x0f & idcode;

        switch ( 0xf0 & idcode ){
            case 0xc0:cur_byte++;break;
            case 0xa0:cur_byte++;break;
            case 0xe0:cur_byte+=2;break;
            case 0xf0:
                cur_byte+=2; // 0x7F 시작 0x00 예약 건너뜀
                var data1=uInt8Array[cur_byte++]; // XX
                //var data2=uInt8Array[cur_byte++]; // YY 1/128
                 data2=uInt8Array[cur_byte++]; // YY 1/128
                ttem=imsHeader.basicTempo * data2 / 128 + imsHeader.basicTempo * data1;
                //ttem=Math.floor(imsHeader.basicTempo * data2 / 128 + imsHeader.basicTempo * data1);
                //ttem=Math.round(imsHeader.basicTempo * data2 / 128 + imsHeader.basicTempo * data1);
                //tickByTime += 60/imsHeader.tickBeat/ttem ;
                //tickByTime += ttem/60/imsHeader.tickBeat*data2 ;
                //tickByTime += ttem/60*data2 ;
                //tickByTime += ttem/60;
                //tickByTime += ttem/imsHeader.tickBeat/60;
                //tickByTime += ttem/imsHeader.tickBeat/60;
                //tickByTime += data1 ;
                //tickByTime += imsHeader.basicTempo/imsHeader.tickBeat*data1 ;
                //tickByTime += ttem/imsHeader.tickBeat*data1 ;
                //tickByTime += Math.round(ttem/imsHeader.tickBeat*data1) ;
                //console.log(data1,data2,ttem,imsHeader.tickBeat,ttem/imsHeader.tickBeat);
                cur_byte++; // 0xF7 종료 건너뜀
                break;
            case 0x80:
                //console.log('0x80');
                cur_byte+=2;
                break;
            case 0x90:cur_byte+=2;break;
        }

        t_delay=0;
        function time_size(){
            ch=uInt8Array[cur_byte++];
            if ( uInt8Array[cur_byte]==0xfc ) cur_byte=0; // data 종료
            if ( ch==0xf8 ){
                t_delay+=240;
                time_size();
            }
        }
        time_size();
        if ( ch ){
            t_delay+=ch;
//            tickByTime += 60*t_delay/imsHeader.tickBeat/ttem ;
        } //else continue;

        if(cur_byte==0){
            cur_byte=71;
//            tick=0;
            break;
        }
//        tick+=t_delay;
//        tickByTime += Math.floor(ttem/60)*t_delay;
//        tickByTime += Math.floor(ttem*t_delay)/60;
//        tickByTime += Math.floor(ttem/60)*(t_delay?t_delay:1);

//		EST_SECOND2+=(60*(double)(FIN_TIME_TICK-TEMP_TICK)/(double)TPB/(double)TEMPO_IS);
//		EST_SECOND2+=(60*(FIN_TIME_TICK-TEMP_TICK)/TPB/TEMPO_IS);
//        tickByTime += 60*t_delay/imsHeader.tickBeat/ttem ;
//        tickByTime += 60*t_delay/imsHeader.tickBeat/ttem ;
/** /
        if(data2)  tickByTime += 60*t_delay/imsHeader.tickBeat/ttem;
        //else       tickByTime += imsHeader.tickBeat/ttem/24;
        else       tickByTime += ttem/imsHeader.tickBeat/60;
//        else       tickByTime += imsHeader.basicTempo/imsHeader.tickBeat/60;
/**/
//        tickByTime += Math.round(60*t_delay/imsHeader.tickBeat/ttem) ;
//        tickByTime += Math.round(60*t_delay/imsHeader.tickBeat/ttem*10)/10 ;
//        tickByTime += (Math.round(60*t_delay/imsHeader.tickBeat/ttem*10)/10) ;
//        tickByTime += Math.round(60*t_delay/imsHeader.tickBeat/ttem*10) ;
//        if(t_delay) tickByTime += 60*t_delay/imsHeader.tickBeat/ttem;
if(t_delay){
    if(t_delay<20000)
        tickByTime += 60*t_delay/imsHeader.tickBeat/ttem;
//    else
//        tickByTime += 1;
//        console.log(t_delay, ttem, 60*t_delay/imsHeader.tickBeat/ttem);;
        //console.log(t_delay, ttem, tickByTime)
}
if(t_delay>20000) console.log(t_delay, ttem, data1, 60*t_delay/imsHeader.tickBeat/ttem)
//        tickByTime += ttem*t_delay / imsHeader.tickBeat / 60;
//        tickByTime += t_delay / imsHeader.tickBeat / 60 * ttem;
//        tickByTime += t_delay / 60;
//        tickByTime += t_delay / imsHeader.tickBeat / 60;
    }
    return tickByTime;
}


chkCount = 0;
var startTime = 0;
function TimeOut(){
    idcode = uInt8Array[cur_byte];

    if ( idcode <0x80 ) idcode=idcode_st;
    else { cur_byte++;idcode_st=idcode; }

    ch=0x0f & idcode;
    //console.log(new Date().toJSON(),'idcode',idcode.toString(2));
    //console.log(new Date().toJSON(),'ch',ch.toString(16),'idcode',idcode.toString(2));
    if(DEBUG) console.log('ch',ch.toString(16),'idcode',idcode.toString(2));

    switch ( 0xf0 & idcode ){
        case 0xc0:ins_rt(ch);break;
        case 0xa0:vol_rt(ch);break;
        case 0xe0:pit_rt(ch);break;
        case 0xf0:tem_rt();break;
        case 0x80:note1_rt(ch);break;
        case 0x90:note2_rt(ch);break;
    }

    t_delay=0;
    //console.log(t_delay,'ch',ch.toString(16),'idcode',idcode.toString(2));
    function time_size(){
        ch=uInt8Array[cur_byte++];
        prtCurByte(ch);
        if ( uInt8Array[cur_byte]==0xfc ) cur_byte=0;
        if ( ch==0xf8 ){
            t_delay+=240;
            time_size();
        }
    }
    time_size();
    if ( ch )
        t_delay+=ch;

    //curByte.innerText = cur_byte.format() + ' / ' + imsHeader.dataSize.format() + ' ( ' + (Math.round(cur_byte/imsHeader.dataSize*1000)/10) + '% )';
    if(cur_byte==0){
        //curByte.innerText = '종료';
        //curByte.innerText = cur_byte.format() + ' / ' + imsHeader.dataSize.format() + ' ( ' + (Math.round(cur_byte/imsHeader.dataSize*1000)/10) + '% ) 종료';
        curByte.innerText += ' 종료';
        console.log(new Date().toJSON(),'Stop'
                   , new Date().getTime()-startTime
                   , new Date( new Date().getTime()-startTime )
                        .toJSON()
                        .replace(/\d{4}\-\d{2}-\d{2}T\d{2}:(\d{2}:\d{2})\.\d{1,3}Z/,'$1'));
        //startTime = new Time().getTime()-startTime;
        //console.log(new Time().getTime()-startTime);
        doRun();   // 재생중지
        doStart(); // 재생관련 초기화
        cur_byte=71;
        return;
    }
    tick+=t_delay;
    tickNo.innerText = tick.format();
    //return (t_delay);
    //if(chkCount>11) return;
    //if(chkCount>300) return;
    if(!isRun) return;
    //else setTimeout(TimeOut, t_delay);
    //else setTimeout(TimeOut, 10);
    //else setTimeout(TimeOut, ttem/10);
    //else setTimeout(TimeOut, 250-ttem);
    else {
        //var time = t_delay?((t_delay/ttem) * (298295/ttem/10)):1/50;
        //var time = t_delay?((t_delay/ttem) * (298295/ttem/20)):1/50;
        //var time = t_delay?(ttem * (298295/ttem/1000000)):1/50;
        //var time = ttem * (298295/ttem/1000000);
        //var time = t_delay;
        //var time = 1;
        //var time = (imsHeader.basicTempo / 60) * t_delay;
        //var time = (ttem / 60) * t_delay;
        var time = ((480-ttem) / 60) * t_delay * 0.2 * (ttem/imsHeader.tickBeat);
        //var time = (imsHeader.basicTempo / 60) * t_delay * 0.2;
        setTimeout(TimeOut, time);
    }
    chkCount++;
}

function ins_rt( ch ){
    var timbre;
    //console.log(new Date().toJSON(),'uInt8Array['+cur_byte+']',uInt8Array[cur_byte].toString(16));
    if(DEBUG) console.log('uInt8Array['+cur_byte+']',uInt8Array[cur_byte].toString(16));
    //tibre=ins_data+uInt8Array[cur_byte++]*28;
    timbre=uInt8Array[cur_byte++];
    SetVoiceTimbre(ch,timbre);
}

function vol_rt( ch ){
    cur_vol[ch]=uInt8Array[cur_byte++];
    SetVoiceVolume( ch, cur_vol[ch] );
}

function pit_rt( ch ){
    data1 =uInt8Array[cur_byte+1]<<8;
    data1+=uInt8Array[cur_byte  ];
    data1=data1>>1;
    SetVoicePitch(ch,data1);
    cur_byte+=2;
}

function tem_rt(){
    cur_byte+=2; // 0x7F 시작 0x00 예약 건너뜀
    data1=uInt8Array[cur_byte++]; // XX
    data2=uInt8Array[cur_byte++]; // YY 1/128
    ttem=imsHeader.basicTempo;
    ttem=ttem * data2 / 128 + imsHeader.basicTempo * data1;
    document.querySelector('#imsTempo').innerText = 'TEMPO : ' + Math.floor(ttem);
    rate=Math.floor(298295/ttem);
    SetClkRate(rate);
    cur_byte++; // 0xF7 종료 건너뜀
}
/*
	cur_tempo=(ttem=(unsigned long)(((unsigned long)basic_tempo*data2)>>7)+(unsigned long)basic_tempo*data1);
	cur_tempo=(ttem=((basic_tempo*data2)>>7)+basic_tempo*data1);
	if(ttem<=0) ttem=1;
	rate=1193180L/(TPB*(unsigned long)(TEMPO=(unsigned)ttem)*ACC_TEMPO/6000);
	SetClkRate(rate);
*/


cur_vol = [0,0,0,0,0, 0,0,0,0,0, 0];
function note1_rt( ch ){
    data1=uInt8Array[cur_byte+1];
    NoteOff (ch);
    if ( cur_vol[ch]!=data1 ) {
        cur_vol[ch]=data1;
        SetVoiceVolume( ch, data1 );
    }
    NoteOn ( ch, uInt8Array[cur_byte] );
    cur_byte+=2;
}

function note2_rt(ch){
    data1=uInt8Array[cur_byte+1];
    NoteOff (ch);
    if ( data1 ) {
        if ( cur_vol[ch]!=data1 ) {
            cur_vol[ch]=data1;
            SetVoiceVolume( ch, data1 );
        }
        NoteOn ( ch, uInt8Array[cur_byte] );
    }
    cur_byte+=2;
}

//////// Adlib Start
function SetVoiceTimbre(ch, tibire){
    //console.log(new Date().toJSON(),'SetVoiceTimbre('+ch+', '+tibire+')',ins_name[tibire]);
    if(DEBUG) console.log('SetVoiceTimbre('+ch+', '+tibire+')',ins_name[tibire]);
    document.querySelector('#insNmCh'+ch).innerText = ins_name[tibire];
}

var PITCH = [0,0,0,0,0, 0,0,0,0,0, 0]
function SetVoicePitch(ch, data1){
    if(DEBUG) console.log('SetVoicePitch('+ch+', '+data1+')');
    //document.querySelector('#insPitCh'+ch).innerText = PITCH[ch]?(PITCH[ch]<data1?'▲':'▼'):'';
    var txt = '';
    if(PITCH[ch]){
        /*
        if(PITCH[ch]<data1) txt = '▲';
        else if(PITCH[ch]>data1) txt = '▼';
        else txt='';
        */
        if(8192<data1) txt = '▲';
        if(8192>data1) txt = '▼';
    }
    document.querySelector('#insPitCh'+ch).innerText = txt;
    PITCH[ch]=data1;
}

function SetClkRate(rate){
    if(DEBUG) console.log('SetClkRate('+rate+')');
//    document.querySelector('#imsTempo').innerText = 'TEMPO : ' + rate;
}

function NoteOff( ch ){
    if(DEBUG) console.log('NoteOff('+ch+')');
    document.querySelector('#insPanCh'+ch).innerText = '';
    document.querySelector('#insLvCh' +ch).style.width = '1px';

    NOTE[ch] = 0;
    //fluctuate(document.querySelector('.bar-'+ch), 1);
}

function SetVoiceVolume( ch, data1 ){
    if(DEBUG) console.log('SetVoiceVolume('+ch+', '+data1+')');
    document.querySelector('#insVolCh'+ch).innerText = data1;

    cur_vol[ch]=data1; // add 2025-03-07
    //fluctuate(document.querySelector('.bar-'+ch), cur_vol[ch]);
}

var PIT_METER=["C ", "C#", "D ", "D#", "E ", "F ", "F#", "G ", "G#", "A ", "A#", "B "];
function NoteOn ( ch, data ){
    if(DEBUG) console.log('NoteOn('+ch+', '+data+')');
    document.querySelector('#insNotCh'+ch).innerText = PIT_METER[ data%12 ] + (Math.floor(data/12) -1);
    document.querySelector('#insLvCh' +ch).style.width = data + 'px';
    document.querySelector('#insPanCh'+ch).innerText = '<>';

    NOTE[ch] = data;
    //fluctuate(document.querySelector('.bar-'+ch), cur_vol[ch]);

//    ctx.fillStyle = NOTEC[ch];
//    ctx.fillRect(canvasX,canvas.offsetHeight-data,1,1);
}
//////// Adlib End

// 사운드 이퀄라이저 애니메이션
function fluctuate(bar,vol,) {
    //var height = Math.floor(Math.random() * 40) + 1;
    /*
    //Animate the equalizer bar repeatedly
    bar.animate({
        //height: height
        height: vol
    }, function() {
        //fluctuate($(this));
    });
    */
    bar.style.height = vol+'px';
    //bar.style.height = (vol/127*100)+'%';
    //bar.style.cssText = "animation-duration:3s;animation-name:slidein;height:${vol};";

    /** /
    bar.animate([
        {height:  vol     + 'px'},
//        {height:  vol     + 'px'},
        {height: (vol/95) + 'px'},
//        {height: (vol/90) + 'px'},
//        {height: (vol/80) + 'px'},
//        {height: (vol/60) + 'px'},
//        {height: (vol/30) + 'px'},
        {height:  1       + 'px'}
    ],3000);
    /**/
    //bar.animate({height:vol+'px'},127);
}


    function doRun(){
        if(isRun){
            //btnPlay.innerText = 'Play';
            btnPlay.innerText = '▶️';
            isRun = false;
        } else {
            startTime = new Date().getTime();
            console.log(new Date().toJSON(),'Play')
            //btnPlay.innerText = 'Stop';
            btnPlay.innerText = '⏸';
            isRun = true;
            TimeOut();
            DrawNote();
        }
    }
    function doStart(){
        cur_byte = 71; // ims data 시작위치로
        //prtCurByte();  // cur_byte 관련 정보 출력 
        playTime=0;    // 연주시간 초기화
        //tick=0;

        // canvas reset
        canvasX=0;
        ctx.clearRect(0,0,canvas.offsetWidth,canvas.offsetHeight);

//        getDuration(); //재생시간 구함
    }

    var NOTE  = [0,0,0,0,0, 0,0,0,0,0, 0];
    var NOTEC = ['#ff0000','#660000','#666600','#669900','#ffff00'
                ,'#cc00ff','#cccc99','#006600','#003399','#3300ff', '#00ccff'];
    var canvasX=0;
    function DrawNote(){
        //ctx.fillRect(canvasX,(Math.random()*100).toFixed(0),1,1);
        //NOTE.forEach(item=>{if(item) ctx.fillRect(canvasX,item,1,1);});
        NOTE.forEach((item,idx)=>{
            if(item) {
                ctx.fillStyle = NOTEC[idx];
                ctx.fillRect(canvasX,canvas.offsetHeight-item,1,1);

                composer.draw(item, NOTEC[idx]);

                fluctuate(document.querySelector('.bar-'+idx), cur_vol[idx]);
            }else
                fluctuate(document.querySelector('.bar-'+idx), 1);
        });
        canvasX++;
        if(canvasX>=canvas.offsetWidth){
            canvasX=0;
            ctx.clearRect(0,0,canvas.offsetWidth,canvas.offsetHeight);
        }
        composer.move();
        //if(isRun)setTimeout(DrawNote,20);
        if(isRun)setTimeout(DrawNote,18);
    }

var Timer = function(callback, delay) {
    var timerId, start, remaining = delay;

    this.pause = function() {
        window.clearTimeout(timerId);
        timerId = null;
        remaining -= Date.now() - start;
    };

    this.resume = function() {
        if (timerId) {
            return;
        }

        start = Date.now();
        timerId = window.setTimeout(callback, remaining);
    };

    this.resume();
};

    // Composer 관련개체
    function Composer(id){
        this.el = document.querySelector(id);
        this.compCav = document.createElement('canvas');
        this.el.appendChild(this.compCav);
        //compCav.id = 'compCav';
        this.compCav.width  = this.compCav.offsetWidth;
        this.compCav.height = this.compCav.offsetHeight;
        this.ctx = this.compCav.getContext("2d");
        var resize = (()=>{ // 사이즈 변경시 
            var el = this.compCav;
            return (e)=>{
                el.width  = el.offsetWidth;
                el.height = el.offsetHeight;
            }
        })();
        window.addEventListener("resize", resize);
//        this.el.addEventListener("resize", resize); // 왜 안됨?
        this.x = 0;
    }
    Composer.prototype = {
         init : function(){ // 초기화
            this.x=0;
            this.ctx.clearRect(0,0,this.compCav.offsetWidth,this.compCav.offsetHeight);
         }
        ,set  : (param)=>{
            if(param.color) {}
        }
        ,draw : function(y, color){ // 캔버스에 한 점 표시
            this.ctx.fillStyle = color || 'blue';
            this.ctx.fillRect(this.x,this.compCav.offsetHeight-y,1,1);
        }
        ,move : function(){
            this.x = ++this.x % this.compCav.offsetWidth;
            //this.ctx.clearRect(this.x,this.compCav.offsetHeight,10,this.compCav.offsetHeight);
            if(!this.x) this.init();
        }
    }


    //재생시간 출력
    var t = (()=>{
        var playTime = 0;
        return window.setInterval(function() {
            if(isRun) {
                runTime.innerText = `${Math.floor(playTime/60)}:${(playTime%60).to2()}`;
                playTime++;
            }
        }, 1000)
    })();

    var composer;
    window.addEventListener("load", function(e){
        if(DEBUG) console.log(new Date().toJSON(),'window.onload START');
        //Ajax(url || 'KJM1.IMS')
        //Ajax(url || '100MEET.IMS')
        //Ajax(url || 'COM-DRAM.IMS')
//        Ajax(url || 'DEEPYOU.IMS');
        fetch(url || 'DEEPYOU.IMS')
            .then(rs=>{return rs.arrayBuffer();})
            .then(buffer => loadIMS(buffer));

        orgTime.innerText = (+d).timeFormat(); // 목록에 받아온 재생시간값 화면표시

        var canvas = document.getElementById("canvas");
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx = canvas.getContext("2d");
        //canvasDiv

        composer = new Composer('#canDiv');
        if(DEBUG) console.log(new Date().toJSON(),'window.onload END');
    });
/*
    window.addEventListener("resize", function(e){
        console.log('resize');
    });
*/
  </script>
</head>
<body>
<div style="display: -webkit-box;display:flex;flex-wrap:wrap;">
  <div id=imsTitle>Title</div>
  <button onClick="doStart()">⏮</button>
  <button id=btnPlay onClick="doRun()">▶️</button>
</div>
<div id=imsFile>Filename Size</div>
<div id=imsTempoDiv style="display: -webkit-box;display:flex;flex-wrap:wrap;">
  <span id=runTime>0:00</span>/<span id=orgTime>00:49</span>
  <span id=imsTempo>Tempo : 255</span>
  Time <span id=tickTime>0</span>
  Tick <span id=tickNo>0</span>
</div>
<div id=cur_byteDiv>cur_byte : <span id=curByte>0</span></div>
<div id=imsIns>
  <table border=0>
    <colgroup>
      <col width=/>
      <col width=90 />
      <col width=127 />
    </colgroup>
    <tr>
      <td class=th>CH</td>
      <td class=th>Instrument</td>
      <td class=th>Level</td>
      <td class=th>Pitch</td>
      <td class=th>Vol</td>
      <td class=th>Note</td>
      <td class=th>Pan</td>
      <td class="th insEven">Event</td>
    </tr>
    <tr>
      <td class="channel">01</td>
      <td class=insName id=insNmCh0>&nbsp;</td>
      <td><span style="width:127px;"><hr id=insLvCh0 class="level"></span></td>
      <td class=insPitc id=insPitCh0>&nbsp;</td>
      <td class=insVolu id=insVolCh0>&nbsp;</td>
      <td class=insNote id=insNotCh0>&nbsp;</td>
      <td class=insPann id=insPanCh0>&nbsp;</td>
      <td class=insEven id=insEvtCh0>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">02</td>
      <td class=insName id=insNmCh1>&nbsp;</td>
      <td><hr id=insLvCh1 class="level"></td>
      <td class=insPitc id=insPitCh1>&nbsp;</td>
      <td class=insVolu id=insVolCh1>&nbsp;</td>
      <td class=insNote id=insNotCh1>&nbsp;</td>
      <td class=insPann id=insPanCh1>&nbsp;</td>
      <td class=insEven id=insEvtCh1>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">03</td>
      <td class=insName id=insNmCh2>&nbsp;</td>
      <td><hr id=insLvCh2 class="level"></td>
      <td class=insPitc id=insPitCh2>&nbsp;</td>
      <td class=insVolu id=insVolCh2>&nbsp;</td>
      <td class=insNote id=insNotCh2>&nbsp;</td>
      <td class=insPann id=insPanCh2>&nbsp;</td>
      <td class=insEven id=insEvtCh2>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">04</td>
      <td class=insName id=insNmCh3>&nbsp;</td>
      <td><hr id=insLvCh3 class="level"></td>
      <td class=insPitc id=insPitCh3>&nbsp;</td>
      <td class=insVolu id=insVolCh3>&nbsp;</td>
      <td class=insNote id=insNotCh3>&nbsp;</td>
      <td class=insPann id=insPanCh3>&nbsp;</td>
      <td class=insEven id=insEvtCh3>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">05</td>
      <td class=insName id=insNmCh4>&nbsp;</td>
      <td><hr id=insLvCh4 class="level"></td>
      <td class=insPitc id=insPitCh4>&nbsp;</td>
      <td class=insVolu id=insVolCh4>&nbsp;</td>
      <td class=insNote id=insNotCh4>&nbsp;</td>
      <td class=insPann id=insPanCh4>&nbsp;</td>
      <td class=insEven id=insEvtCh4>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">06</td>
      <td class=insName id=insNmCh5>&nbsp;</td>
      <td><hr id=insLvCh5 class="level"></td>
      <td class=insPitc id=insPitCh5>&nbsp;</td>
      <td class=insVolu id=insVolCh5>&nbsp;</td>
      <td class=insNote id=insNotCh5>&nbsp;</td>
      <td class=insPann id=insPanCh5>&nbsp;</td>
      <td class=insEven id=insEvtCh5>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">BD</td>
      <td class=insName id=insNmCh6>&nbsp;</td>
      <td><hr id=insLvCh6 class="level"></td>
      <td class=insPitc id=insPitCh6>&nbsp;</td>
      <td class=insVolu id=insVolCh6>&nbsp;</td>
      <td class=insNote id=insNotCh6>&nbsp;</td>
      <td class=insPann id=insPanCh6>&nbsp;</td>
      <td class=insEven id=insEvtCh6>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">SD</td>
      <td class=insName id=insNmCh7>&nbsp;</td>
      <td><hr id=insLvCh7 class="level"></td>
      <td class=insPitc id=insPitCh7>&nbsp;</td>
      <td class=insVolu id=insVolCh7>&nbsp;</td>
      <td class=insNote id=insNotCh7>&nbsp;</td>
      <td class=insPann id=insPanCh7>&nbsp;</td>
      <td class=insEven id=insEvtCh7>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">TM</td>
      <td class=insName id=insNmCh8>&nbsp;</td>
      <td><hr id=insLvCh8 class="level"></td>
      <td class=insPitc id=insPitCh8>&nbsp;</td>
      <td class=insVolu id=insVolCh8>&nbsp;</td>
      <td class=insNote id=insNotCh8>&nbsp;</td>
      <td class=insPann id=insPanCh8>&nbsp;</td>
      <td class=insEven id=insEvtCh8>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">CY</td>
      <td class=insName id=insNmCh9>&nbsp;</td>
      <td><hr id=insLvCh9 class="level"></td>
      <td class=insPitc id=insPitCh9>&nbsp;</td>
      <td class=insVolu id=insVolCh9>&nbsp;</td>
      <td class=insNote id=insNotCh9>&nbsp;</td>
      <td class=insPann id=insPanCh9>&nbsp;</td>
      <td class=insEven id=insEvtCh9>&nbsp;</td>
    </tr>
    <tr>
      <td class="channel">HH</td>
      <td class=insName id=insNmCh10>&nbsp;</td>
      <td><hr id=insLvCh10 class="level"></td>
      <td class=insPitc id=insPitCh10>&nbsp;</td>
      <td class=insVolu id=insVolCh10>&nbsp;</td>
      <td class=insNote id=insNotCh10>&nbsp;</td>
      <td class=insPann id=insPanCh10>&nbsp;</td>
      <td class=insEven id=insEvtCh10>&nbsp;</td>
    </tr>
  </table>
<span style='flex-grow: 1;flex-basis: 200px;'>
    <span class="eq">
        <span class="bar bar-0"></span>
        <span class="bar bar-1"></span>
        <span class="bar bar-2"></span>
        <span class="bar bar-3"></span>
        <span class="bar bar-4"></span>
        <span class="bar bar-5"></span>
        <span class="bar bar-6"></span>
        <span class="bar bar-7"></span>
        <span class="bar bar-8"></span>
        <span class="bar bar-9"></span>
        <span class="bar bar-10"></span>
    </span>
    <!-- <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkqAcAAIUAgUW0RjgAAAAASUVORK5CYII="> -->
    <span id=canvasDiv>
      <canvas id="canvas" width="100" height="100">
        캔버스의 내용을 설명하는 대체 텍스트
      </canvas>
    </span>
</span>
</div>

<div style="display:flex;">
<span id=volDiv style="width:50%;"></span>
<span id=canDiv style="width:50%;"></span>
</div>

<!-- 
    <div class="bars-container">
        <div class="bar-1"></div>
        <div class="bar-2"></div>
        <div class="bar-3"></div>
        <div class="bar-4"></div>
        <div class="bar-5"></div>
        <div class="bar-6"></div>
        <div class="bar-7"></div>
    </div>
 -->
    <!-- <link rel="stylesheet" href="soundbars.css"> -->
<!-- 
<div class="eq">
    <span class="bar bar-0"></span>
    <span class="bar bar-1"></span>
    <span class="bar bar-2"></span>
    <span class="bar bar-3"></span>
    <span class="bar bar-4"></span>
    <span class="bar bar-5"></span>
    <span class="bar bar-6"></span>
    <span class="bar bar-7"></span>
    <span class="bar bar-8"></span>
    <span class="bar bar-9"></span>
    <span class="bar bar-10"></span>
</div>
<div id=canvasDiv>
  <canvas id="canvas" width="100" height="100">
    캔버스의 내용을 설명하는 대체 텍스트
  </canvas>
</div>
 -->
<div id=listDiv></div>
<br>
<div id=pageDiv></div>

</body>
</html>
